"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getProjectedExtentAsBBOXString = exports.updateModel = exports.saveModel = void 0;
const hub_common_1 = require("@esri/hub-common");
const geometry_1 = require("./geometry");
const arcgis_rest_portal_1 = require("@esri/arcgis-rest-portal");
/**
 * Save an IModel. Generic function that will be used across all
 * type-specific save functions
 *
 * @export
 * @param {IModel} "model" object (i.e. `{item:{...}, data:{...}}`)
 * @param {IRequestOptions} requestOptions
 * @returns {Promise<IModel>}
 */
function saveModel(model, requestOptions) {
    const clone = hub_common_1.cloneObject(model);
    const opts = createRequestOptions(clone, requestOptions);
    return arcgis_rest_portal_1.createItem(opts).then((response) => {
        clone.item.id = response.id;
        return clone;
    });
}
exports.saveModel = saveModel;
/**
 * Update an IModel. Generic function that will be used across all
 * type-specific update functions
 *
 * @export
 * @param {IModel} "model" object (i.e. `{item:{...}, data:{...}}`)
 * @param {IRequestOptions} requestOptions
 * @returns {Promise<IModel>}
 */
function updateModel(model, requestOptions) {
    const clone = hub_common_1.cloneObject(model);
    const opts = createRequestOptions(clone, requestOptions);
    return arcgis_rest_portal_1.updateItem(opts).then(() => {
        // return a new ref to the model that was passed in...
        return clone;
    });
}
exports.updateModel = updateModel;
/**
 * Centralize the serialization of an IModel into an object
 * that we can send to the Item methods
 *
 * @param {IModel} model
 * @param {IRequestOptions} requestOptions
 * @returns {*}
 */
function createRequestOptions(model, requestOptions) {
    // construct an object to send to the API
    const item = hub_common_1.cloneObject(model.item);
    item.data = hub_common_1.cloneObject(model.data);
    // create the options...
    const opts = Object.assign({ item }, requestOptions);
    return opts;
}
/**
 * Given an extent, project it and return a BBOX lat/long string, which is the format
 * required when creating an item.
 * @param orgExtent Extent to project
 * @param portal
 * @returns {Promise<any>} Promise that will resolve with a bbox string (W,S,E,N)
 */
function getProjectedExtentAsBBOXString(options, requestOptions) {
    const url = geometry_1.default.getUrl(options.portal);
    return geometry_1.default
        .project(url, options.extent.spatialReference.wkid, 4326, "esriGeometryEnvelope", [options.extent], requestOptions)
        .then((response) => {
        const ext4326 = response.geometries[0];
        return (ext4326.xmin +
            "," +
            ext4326.ymin +
            "," +
            ext4326.xmax +
            "," +
            ext4326.ymax);
    });
}
exports.getProjectedExtentAsBBOXString = getProjectedExtentAsBBOXString;
//# sourceMappingURL=model.js.map