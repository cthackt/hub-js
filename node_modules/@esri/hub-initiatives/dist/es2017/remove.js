import { removeInitiativeGroup } from "./groups";
import { getInitiative } from "./get";
import { detachSiteFromInitiative } from "./detach-site";
import { getItem, removeItem, unprotectItem, getSelf } from "@esri/arcgis-rest-portal";
import { getProp, createId } from "@esri/hub-common";
/**
 * Remove an Initiative, and its associated groups.
 * If the initiative has a site, it will be shared to
 * the organization's main collaboration group
 * @export
 * @param {string} id
 * @param {IRequestOptions} requestOptions
 * @returns {Promise<any>}
 */
export function removeInitiative(id, requestOptions) {
    const state = {
        id
    };
    const processId = createId("remove-");
    const startTS = new Date().getTime();
    // first get the item, because we need to also remove the
    // collaboration and open data groups...
    // and the Portal because w need the org's default
    // collaboration group id
    return Promise.all([
        getInitiative(id, requestOptions),
        getSelf(requestOptions)
    ])
        .then(async (results) => {
        const model = results[0];
        const portal = results[1];
        const siteId = model.item.properties.siteId;
        if (siteId) {
            try {
                await getItem(siteId, requestOptions);
                state.hasSite = true;
                state.siteId = siteId;
            }
            catch (e) {
                state.hasSite = false;
            }
        }
        else {
            state.hasSite = false;
        }
        state.initiativeOwner = model.item.owner;
        state.collaborationGroupId = getProp(portal, "properties.openData.settings.groupId");
        // remove the groups...
        const prms = [];
        ["collaborationGroupId", "contentGroupId", "followersGroupId"].forEach(prop => {
            if (model.item.properties[prop]) {
                prms.push(removeInitiativeGroup(model.item.properties[prop], requestOptions).catch(() => Promise.resolve(true)) // swallow group delete failures
                );
            }
        });
        // if the item is protected, un-protect it...
        if (model.item.protected) {
            const opts = Object.assign({ id }, requestOptions);
            prms.push(unprotectItem(opts));
        }
        return Promise.all(prms);
    })
        .then(() => {
        const prms = [];
        const opts = Object.assign({ id, owner: state.initiativeOwner }, requestOptions);
        prms.push(removeItem(opts));
        // if we have a site, let's detach it from the initiative
        if (state.hasSite) {
            prms.push(detachSiteFromInitiative(state.siteId, state.collaborationGroupId, requestOptions));
        }
        return Promise.all(prms);
    })
        .then(() => {
        return { success: true };
    });
}
//# sourceMappingURL=remove.js.map