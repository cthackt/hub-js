"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getItems = void 0;
const arcgis_rest_portal_1 = require("@esri/arcgis-rest-portal");
const encode_ago_query_1 = require("./encode-ago-query");
const hub_common_1 = require("@esri/hub-common");
const MAX_COUNTFIELDS = 3;
// Search for Items in ArcGIS and return raw ago response
async function getItems(params, token, portal, authentication) {
    const agoParams = encode_ago_query_1.encodeAgoQuery(params);
    if (agoParams.countFields) {
        const chunkedCountFields = hub_common_1.chunkArray(agoParams.countFields.split(","), MAX_COUNTFIELDS).map((fieldArrayChunk) => fieldArrayChunk.join(","));
        const promises = chunkedCountFields.map((chunk) => {
            const countFields = chunk;
            return arcgis_rest_portal_1.searchItems(Object.assign(Object.assign({}, agoParams), { params: {
                    // NOTE: we shouldn't need this since we pass in authentication below
                    token,
                    countFields,
                    countSize: agoParams.countSize,
                }, countFields,
                portal,
                authentication, httpMethod: "POST" }));
        });
        const responses = await Promise.all(promises);
        let allCounts = [];
        for (const response of responses) {
            const counts = hub_common_1.getProp(response, "aggregations.counts") || [];
            allCounts = allCounts.concat(counts);
        }
        responses[0].aggregations = {
            counts: allCounts,
        };
        return responses[0];
    }
    else {
        return arcgis_rest_portal_1.searchItems(Object.assign(Object.assign({}, agoParams), { params: {
                // NOTE: we shouldn't need this since we pass in authentication below
                token,
            }, portal, httpMethod: "POST", authentication }));
    }
}
exports.getItems = getItems;
//# sourceMappingURL=get-items.js.map